name: Push Python Package to Cloudsmith with OIDC
on:
  push:
    branches:
      - main # Trigger on push to the main branch
permissions:
  id-token: write # Required for requesting the JWT token for OIDC
  contents: read # Required for actions/checkout
jobs:
  build:
    runs-on: ubuntu-latest # Use an Ubuntu runner for the job
    steps:
      # Checkout the repository
      - name: Check out code
        uses: actions/checkout@v4
      - name: Get OIDC token and generate Cloudsmith API token
        # Authenticate with OIDC and exchange for Cloudsmith API token

        env:
          AUDIENCE: "api://AzureADTokenExchange"
        run: |
          echo "Requesting OIDC token from GitHub..."
          oidc_token=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=${AUDIENCE}" | jq -r '.value')

          echo "Exchanging OIDC token for Cloudsmith API key..."
          cloudsmith_token=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"oidc_token\":\"$oidc_token\", \"service_slug\":\"SERVICE_ACCOUNT_SLUG\"}" \
            https://api.cloudsmith.io/openid/interview-shahid-ahmed/ | jq -r '.token')

          echo "CLOUDSMITH_API_KEY=$cloudsmith_token" >> $GITHUB_ENV
      - name: Validate Cloudsmith API token
        # Test the API token by fetching user details

        run: |
          curl -s --request GET --url https://api.cloudsmith.io/v1/user/self/ \
            --header "Authorization: Bearer $CLOUDSMITH_API_KEY" \
            --header "Accept: application/json"
      - name: Set up Python
        # Set up Python

        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install dependencies
        # Install dependencies

        run: |
          python -m pip install --upgrade pip
          pip install setuptools twine
      - name: Build the package
        # Build the Python package

        run: python setup.py sdist
      - name: Push Python Package to Cloudsmith
        # Push the Python package to Cloudsmith

        uses: cloudsmith-io/action@v0.5.3
        with:
          command: "push"
          format: "python"
          owner: "interview-shahid-ahmed" # Replace with your Cloudsmith org/username
          repo: "shahid-repo" # Replace with your Cloudsmith repository name
          file: "dist/*" # Path to the built package
          republish: "false" # Set to 'true' if overwriting an existing version
